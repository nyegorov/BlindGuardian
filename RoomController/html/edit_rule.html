<HTML>
<HEAD>
    <meta name="viewport" content="width=400, initial-scale=1">
    <title>Add/Edit blind control rules</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        function GetURLParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) return sParameterName[1];
            }
        }
        function load_rule(id) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'rules.json?id=' + id, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) return;
                if (xhr.status == 200) {
                    var rule = JSON.parse(xhr.responseText);
                    rule_name.value = rule.name;
                    enabled.checked = rule.enabled;
                    condition.value = rule.condition;
                    action.value = rule.action;
                }
            }
            xhr.send();
        }

        function get_rule(id) {
            var rule = {
                id:         id,
                name:       rule_name.value,
                condition:  condition.value,
                action:     action.value,
                enabled:    enabled.checked
            };
            return JSON.stringify(rule);
        }

        function save_rule(id) {
            var xhr = new XMLHttpRequest();
            xhr.open(rule_id ? 'PUT' : 'POST', 'rules.json', true);
            xhr.onreadystatechange = function () { if (xhr.status == 200 || xhr.status == 201) window.location.href = "status"; }
            xhr.send(get_rule(id));
        }

        function delete_rule(id) {
            var xhr = new XMLHttpRequest();
            xhr.open('DELETE', 'rules.json?id=' + id, true);
            xhr.onreadystatechange = function () { if (xhr.status == 200) window.location.href = "status"; }
            xhr.send();
        }

        rule_id = parseInt(GetURLParameter('id'));
        load_rule(rule_id);

        window.onload = function () {
            var siteWidth = 400;
            var scale = screen.width / siteWidth
            document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=' + siteWidth + ', initial-scale=' + scale + '');

            if (rule_id == 0) {
                header.innerHTML = "Add rule";
                delete_rule.hidden = true;
            }
        }

        document.addEventListener('keyup', (event) => { if (event.keyCode == 27) history.back(); }, false);
    </script>
</HEAD>
<BODY>
    <h1 id="header">Edit rule</h1>
    <form action="status" method="post" accept-charset="utf-8">
        <h3>Rule name</h3>
        <input id="rule_name" name="rule_name" type="text" required="required" size="48"><br />
        <br />
        <input id="enabled" name="enabled" type="checkbox" checked="checked" value="1">Enabled<br />

        <h3>Condition</h3>
        <textarea id="condition" cols="46" name="condition" rows="7"></textarea><br />
        <span style="color:green">Sensors: <B>temp_in, temp_out, light, inactivity, time</B></span><br />

        <h3>Action</h3>
        <textarea id="action" cols="46" name="action" rows="4"></textarea><br />
        <span style="color:green">Actions: <B>blind.open(), blind.close(), beep(ms), wait(ms)</B></span><br />
    </form>

    <button id="save_rule" onclick="save_rule(rule_id)">Save</button>
    <button id="delete_rule" onclick="delete_rule(rule_id)">Delete</button>
</BODY>
</HTML>
