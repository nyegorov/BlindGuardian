<HTML>
<HEAD>
    <meta name="viewport" content="width=400, initial-scale=1">
    <title>Add/Edit blind control rules</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        function GetURLParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) return sParameterName[1];
            }
        }
        function load_rule(id) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'rule.json?id=' + id, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) return;
                if (xhr.status == 200) {
                    var rule = JSON.parse(xhr.responseText);
                    rule_name.value = rule.name;
                    condition.value = rule.condition;
                    action.value = rule.action;
                    delete_rule.value = rule.id;
                    save_rule.value = rule.id;
                }
            }
            xhr.send();
        }

        rule_id = GetURLParameter('id');
        load_rule(rule_id);

        window.onload = function () {
            var siteWidth = 400;
            var scale = screen.width / siteWidth
            document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=' + siteWidth + ', initial-scale=' + scale + '');

            if (rule_id == 0) {
                header.innerHTML = "Add rule";
                delete_rule.hidden = true;
            }
        }

        document.addEventListener('keyup', (event) => { if (event.keyCode == 27) history.back(); }, false);
    </script>
</HEAD>
<BODY>
    <h1 id="header">Edit rule</h1>
    <form action="status" method="post" accept-charset="utf-8">
        <h3>Rule name</h3>
        <input id="rule_name" name="rule_name" type="text" required="required" size="48"><br />

        <h3>Condition</h3>
        <textarea id="condition" cols="46" name="condition" rows="7"></textarea><br />
        <span style="color:green">Sensors: <B>temp_in, temp_out, light, inactivity, time</B></span><br />

        <h3>Action</h3>
        <textarea id="action" cols="46" name="action" rows="4"></textarea><br />
        <span style="color:green">Actions: <B>blind.open(), blind.close()</B></span><br/>
        <br />

        <button id="save_rule" name="save_rule" value="rule_id" type="submit">Save</button>
        <button id="delete_rule" name="delete_rule" value="rule_id">Delete</button>
</form>
</BODY>
</HTML>
